# 自動投稿スケジューラー (1日15投稿)
#
# このワークフローは定期的にauto-post APIを呼び出し、
# X（Twitter）への自動投稿を実行します。
#
# 必要なSecretsの設定:
#   VERCEL_DEPLOY_URL: デプロイ先のURL (例: https://your-app.vercel.app)
#   AUTO_POST_SECRET: 認証用シークレット (任意)

name: Auto Post Scheduler

on:
  # 定期実行 (UTC時間) - 日本時間 = UTC + 9
  schedule:
    # Slot 1:  6:30 JST = 21:30 UTC前日
    - cron: '30 21 * * *'
    # Slot 2:  7:30 JST = 22:30 UTC前日
    - cron: '30 22 * * *'
    # Slot 3:  8:30 JST = 23:30 UTC前日
    - cron: '30 23 * * *'
    # Slot 4: 10:00 JST =  1:00 UTC
    - cron: '0 1 * * *'
    # Slot 5: 12:00 JST =  3:00 UTC
    - cron: '0 3 * * *'
    # Slot 6: 12:45 JST =  3:45 UTC
    - cron: '45 3 * * *'
    # Slot 7: 14:00 JST =  5:00 UTC
    - cron: '0 5 * * *'
    # Slot 8: 15:30 JST =  6:30 UTC
    - cron: '30 6 * * *'
    # Slot 9: 17:30 JST =  8:30 UTC
    - cron: '30 8 * * *'
    # Slot 10: 18:30 JST =  9:30 UTC
    - cron: '30 9 * * *'
    # Slot 11: 20:00 JST = 11:00 UTC
    - cron: '0 11 * * *'
    # Slot 12: 21:00 JST = 12:00 UTC
    - cron: '0 12 * * *'
    # Slot 13: 21:45 JST = 12:45 UTC
    - cron: '45 12 * * *'
    # Slot 14: 22:30 JST = 13:30 UTC
    - cron: '30 13 * * *'
    # Slot 15: 23:30 JST = 14:30 UTC
    - cron: '30 14 * * *'

  # 手動実行も可能
  workflow_dispatch:
    inputs:
      slot:
        description: '投稿スロット (1-15、0=自動判定)'
        required: false
        default: '0'
        type: string
      dry_run:
        description: 'ドライラン (投稿しない)'
        required: false
        default: 'false'
        type: boolean

jobs:
  auto-post:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Determine Time Slot
        id: slot
        run: |
          # 手動実行時はinputを使用、スケジュール時は時間から判定
          if [ "${{ github.event.inputs.slot }}" != "" ] && [ "${{ github.event.inputs.slot }}" != "0" ]; then
            echo "slot=${{ github.event.inputs.slot }}" >> $GITHUB_OUTPUT
          else
            # 現在のUTC時間から日本時間のスロットを判定
            HOUR=$(date -u +%H)
            MIN=$(date -u +%M)

            # UTC時間 → スロット対応表
            case "$HOUR:$MIN" in
              21:3*) SLOT=1 ;;   #  6:30 JST おはよう
              22:3*) SLOT=2 ;;   #  7:30 JST ノウハウ
              23:3*) SLOT=3 ;;   #  8:30 JST Q&A
              01:0*) SLOT=4 ;;   # 10:00 JST 体験談
              03:0*) SLOT=5 ;;   # 12:00 JST 共感
              03:4*) SLOT=6 ;;   # 12:45 JST 軽い話題
              05:0*) SLOT=7 ;;   # 14:00 JST 実績
              06:3*) SLOT=8 ;;   # 15:30 JST 不安解消
              08:3*) SLOT=9 ;;   # 17:30 JST 共感
              09:3*) SLOT=10 ;;  # 18:30 JST メリット
              11:0*) SLOT=11 ;;  # 20:00 JST 求人
              12:0*) SLOT=12 ;;  # 21:00 JST 成功事例
              12:4*) SLOT=13 ;;  # 21:45 JST 本音
              13:3*) SLOT=14 ;;  # 22:30 JST クロージング
              14:3*) SLOT=15 ;;  # 23:30 JST 夜向け
              *) SLOT=1 ;;
            esac
            echo "slot=$SLOT" >> $GITHUB_OUTPUT
          fi
          echo "Selected slot: $SLOT"

      - name: Call Auto Post API
        env:
          DEPLOY_URL: ${{ secrets.VERCEL_DEPLOY_URL }}
          AUTO_POST_SECRET: ${{ secrets.AUTO_POST_SECRET }}
        run: |
          if [ -z "$DEPLOY_URL" ]; then
            echo "Error: VERCEL_DEPLOY_URL secret is not set"
            exit 1
          fi

          SLOT=${{ steps.slot.outputs.slot }}
          DRY_RUN=${{ github.event.inputs.dry_run || 'false' }}

          echo "Calling auto-post API..."
          echo "  URL: $DEPLOY_URL/api/auto-post"
          echo "  Slot: $SLOT"
          echo "  Dry Run: $DRY_RUN"

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$DEPLOY_URL/api/auto-post" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $AUTO_POST_SECRET" \
            -d "{\"slot\": $SLOT, \"dryRun\": $DRY_RUN}")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)

          echo "Response Code: $HTTP_CODE"
          echo "Response Body: $BODY"

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "Auto post successful!"
          else
            echo "Auto post failed with status $HTTP_CODE"
            exit 1
          fi

      - name: Log Result
        if: always()
        run: |
          echo "Auto post job completed at $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Japan Time: $(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S JST')"
